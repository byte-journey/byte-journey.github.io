<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>View Post</title>
        <link rel="stylesheet" href="../../css/blog-view.css">
        <link rel="icon" href="/favicon.png" type="image/png">
    </head>

    <body>
        <a href="/pages/blog/index.html" class="back-button"><strong>‚óÄ Back to Blog</strong></a>

        <div id="post-container">
            <div id="post-header">
                <h1 id="post-title"></h1>
                <div class="post-engagement">
                    <p id="view-count">Loading views...</p>
                    <p id="like-count">Loading likes...</p>
                    <button id="like-btn">üëç Like this post</button>
                </div>
                <p id="post-desc" class="desc"></p>
                <p id="post-meta"></p>
                <img id="cover-image" src="" alt="Cover" style="display:none;" />
                <div id="post-tags"></div>
            </div>
            <hr/>
            <div id="post-content"></div>
        </div>

        <a href="/pages/blog/index.html" class="back-button"><strong>‚óÄ Back to Blog</strong></a>

        <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

        <script src="../../js/blog.js"></script>
        <script>
            loadBlogPostFromURL(); // Run post-loader
        </script>

        <!-- Firebase -->
        <script type="module">
            import { incrementViewCount, getLikeCount, addLike } from '/js/firebase-blog.js';

            const slug = new URLSearchParams(window.location.search).get('slug');
            if (!slug) return;

            // CRITICAL: Wait for the blog content to load first
            // Use a short delay to ensure blog.js has finished creating elements
            setTimeout(async () => {
                // VIEW COUNT
                const viewCount = await incrementViewCount(slug);
                const viewEl = document.getElementById('view-count');
                if (viewEl) {
                    viewEl.textContent = `${viewCount} view${viewCount === 1 ? '' : 's'}`;
                }

                // LIKES
                const likeCount = await getLikeCount(slug);
                const likeEl = document.getElementById('like-count');
                if (likeEl) {
                    likeEl.textContent = `${likeCount} like${likeCount === 1 ? '' : 's'}`;
                }

                // BUTTON
                const likeBtn = document.getElementById('like-btn');
                if (likeBtn) {
                    likeBtn.addEventListener('click', async () => {
                        const count = await addLike(slug);
                        const likeEl = document.getElementById('like-count');
                        if (likeEl) {
                            likeEl.textContent = `${count} like${count === 1 ? '' : 's'}`;
                        }
                    });
                }
            }, 500); // 500ms delay to ensure DOM elements exist

            // Wait for DOM to be ready
            // document.addEventListener('DOMContentLoaded', async () => {
            //     // VIEW COUNT - increment and display
            //     try {
            //         const viewCount = await incrementViewCount(slug);
            //         const viewEl = document.getElementById('view-count');
            //         if (viewEl) {
            //             viewEl.textContent = `${viewCount} view${viewCount === 1 ? '' : 's'}`;
            //         }
            //     }
            //     catch (error) {
            //         console.error('Failed to load view count:', error);
            //         const viewEl = document.getElementById('view-count');
            //         if (viewEl) viewEl.textContent = 'Views unavailable';
            //     }

            //     // LIKE COUNT - get and display
            //     try {
            //         const likeCount = await getLikeCount(slug);
            //         const likeEl = document.getElementById('like-count');
            //         if (likeEl) {
            //             likeEl.textContent = `${likeCount} like${likeCount === 1 ? '' : 's'}`;
            //         }
            //     }
            //     catch (error) {
            //         console.error('Failed to load like count:', error);
            //         const likeEl = document.getElementById('like-count');
            //         if (likeEl) likeEl.textContent = 'Likes unavailable';
            //     }

            //     // LIKE BUTTON - add click handler
            //     const likeBtn = document.getElementById('like-btn');
            //     if (likeBtn) {
            //         likeBtn.addEventListener('click', async () => {
            //             likeBtn.disabled = true; // Prevent double clicks
            //             likeBtn.textContent = 'Liking...';

            //             try {
            //                 const newCount = await addLike(slug);
            //                 const likeEl = document.getElementById('like-count');
            //                 if (likeEl) {
            //                     likeEl.textContent = `${newCount} like${newCount === 1 ? '' : 's'}`;
            //                 }
            //                 likeBtn.textContent = 'üëç Liked!';

            //                 // Reset button after 2 seconds
            //                 setTimeout(() => {
            //                     likeBtn.textContent = 'üëç Like this post';
            //                     likeBtn.disabled = false;
            //                 }, 2000);
            //             }
            //             catch (error) {
            //                 console.error('Failed to add like:', error);
            //                 likeBtn.textContent = 'üëç Like this post';
            //                 likeBtn.disabled = false;
            //             }
            //         });
            //     }
            // });
        </script>


    </body>
</html>
