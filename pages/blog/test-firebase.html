<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; border: 1px solid red; }
        .success { background: #e6ffe6; border: 1px solid green; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #console { background: black; color: lime; padding: 15px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Firebase Debug Test</h1>
    
    <div class="debug">
        <h3>Test Slug: <span id="test-slug"></span></h3>
        <p>View Count: <span id="view-count">Loading...</span></p>
        <p>Like Count: <span id="like-count">Loading...</span></p>
        <button id="like-btn">üëç Add Like</button>
        <button id="refresh-btn">üîÑ Refresh Counts</button>
    </div>

    <div id="status" class="debug">
        Status: <span id="status-text">Initializing...</span>
    </div>

    <div id="console-container">
        <h3>Debug Console:</h3>
        <div id="console"></div>
    </div>

    <script type="module">
        // Override console.log to also display in page
        const originalLog = console.log;
        const originalError = console.error;
        const consoleDiv = document.getElementById('console');

        console.log = (...args) => {
            originalLog(...args);
            consoleDiv.textContent += args.join(' ') + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        console.error = (...args) => {
            originalError(...args);
            consoleDiv.textContent += 'ERROR: ' + args.join(' ') + '\n';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        // Get test slug
        const urlParams = new URLSearchParams(window.location.search);
        const testSlug = urlParams.get('slug') || 'test-post-' + Date.now();
        document.getElementById('test-slug').textContent = testSlug;

        console.log('üöÄ Starting Firebase debug test with slug:', testSlug);

        // Import Firebase functions
        try {
            const { incrementViewCount, getLikeCount, addLike } = await import('/js/firebase-blog.js');
            console.log('‚úÖ Successfully imported Firebase functions');
            
            document.getElementById('status-text').textContent = 'Firebase loaded successfully';
            document.getElementById('status').className = 'debug success';

            // Auto-increment view count on page load
            setTimeout(async () => {
                console.log('üìà Auto-incrementing view count...');
                const viewCount = await incrementViewCount(testSlug);
                document.getElementById('view-count').textContent = viewCount;
            }, 500);

            // Load initial like count
            setTimeout(async () => {
                console.log('üëç Loading initial like count...');
                const likeCount = await getLikeCount(testSlug);
                document.getElementById('like-count').textContent = likeCount;
            }, 1000);

            // Add like button functionality
            document.getElementById('like-btn').addEventListener('click', async () => {
                console.log('‚ù§Ô∏è Like button clicked!');
                const btn = document.getElementById('like-btn');
                btn.disabled = true;
                btn.textContent = 'Adding like...';
                
                try {
                    const newCount = await addLike(testSlug);
                    document.getElementById('like-count').textContent = newCount;
                    btn.textContent = '‚úÖ Liked!';
                    setTimeout(() => {
                        btn.textContent = 'üëç Add Like';
                        btn.disabled = false;
                    }, 2000);
                } catch (error) {
                    console.error('Failed to add like:', error);
                    btn.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        btn.textContent = 'üëç Add Like';
                        btn.disabled = false;
                    }, 2000);
                }
            });

            // Refresh button functionality
            document.getElementById('refresh-btn').addEventListener('click', async () => {
                console.log('üîÑ Refreshing counts...');
                const likeCount = await getLikeCount(testSlug);
                document.getElementById('like-count').textContent = likeCount;
            });

        } catch (error) {
            console.error('‚ùå Failed to import Firebase functions:', error);
            document.getElementById('status-text').textContent = 'Firebase import failed: ' + error.message;
            document.getElementById('status').className = 'debug error';
        }

        // Add some test buttons
        const addTestButtons = () => {
            const container = document.createElement('div');
            container.innerHTML = `
                <h3>Manual Tests:</h3>
                <button onclick="window.location.search='?slug=test-manual-1'">Test Slug 1</button>
                <button onclick="window.location.search='?slug=test-manual-2'">Test Slug 2</button>
                <button onclick="window.location.search='?slug=my-first-blog-post'">Real Post Test</button>
            `;
            document.body.appendChild(container);
        };

        setTimeout(addTestButtons, 2000);
    </script>
</body>
</html>